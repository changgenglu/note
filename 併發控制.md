# 併發控制

> 悲觀併發控制(悲觀鎖，Pessimistic Concurrency Control / PCC)
>
> 樂觀併發控制(樂觀鎖，Optimistic Concurrency Control / OCC)

## 悲觀鎖

對於 "資料被外界修改" 持保守態度，因此在整個資料處理過程中，將資料處於鎖定狀態，進以阻止一個事務以影響其他用戶的方式來修改資料。

在資料庫中，悲觀鎖的流程為：

1. 在對任意紀錄進行修改前，先嘗試為該紀錄加上排他鎖(exclusive locking)。
2. 如果加鎖失敗，說明該筆資料正在被修改，那麼當前請求可能要等待或者拋出異常，具體影響方式由開發者根據實際需求決定。
3. 若成功加鎖，那就可以對記錄進行修改，待請求完成後就會解鎖了。
4. 期間若有其他對記錄做修改或加排他鎖的操作，都會等待解鎖後或直接拋出異常。

### MySQL InnoDB 使用悲觀鎖

使用悲觀鎖，需先將 mysql 自動提交的屬性關閉，因為 mysql 預設使用 autocommit 模式。

autocommit 模式：當執行一個更新操作後，mysql 會立刻將結果進行提交，若要關閉 `set autocommit=0`, `set autocommit=false`。

```sql
-- 開始請求(三選一)
begin; / begin work; / start transaction;

-- 查詢出商品訊息
select status from t_goods where id=1 for update;

-- 根據商品訊息產生訂單
insert into t_orders (id, goods_id) values (null, 1);

-- 修改商品 status 為 2
update t_goods set status=2;

-- 提交請求
commit; / commit work;
```

使用 `select...for update` 的方式，通過開啟排他鎖的方式實現悲觀鎖，此時在 t_goods 資料表中，id 為 1 的資料會被鎖定，其他的請求必須待本次請求提交後才能執行。
注意，使用 `select...for update` 會把數據鎖住，須注意鎖的級別，MySQL InnoDB 預設為行級鎖(註 1)。行級鎖是基於所索引的，若一條 sql 語句未使用索引，則 mysql 會使用表級鎖(註 2)將整張資料表鎖住。

**註 1**：行級鎖(row-level locking)， mysql 中鎖定的最小單位，只針對目前操作的資料該行進行加鎖。行鎖可大幅減低資料庫操作的衝突，缺點為：開銷大、加鎖慢、會出現死鎖。
**註 2**：表級鎖(table-level locking)， mysql 中最大的鎖定單位，會將目前操作的整張表進行加鎖，開銷小、加鎖快、不會出現死鎖，但發出鎖衝突的機率最高。
**註 3**：死鎖(deadlock)，兩個或多個執行緒由於互相等待，而永遠被阻塞的情況。

### 優點與不足

悲觀併發控制實際採取 "先取鎖再訪問" 的保守策略。在效率方面，處理加鎖的機制會讓資料庫產生額外的負擔，還有增加產生死鎖的機會。也增加了併行性，一個請求若鎖定了某行資料，其他請求則需等待此請求結束才可以處理該行資料

## 樂觀鎖

樂觀鎖假設多用戶併發的請求，不會互相影響。請求可以在不產生鎖的情況下，處理各自影響的那部分數據。在提交資料前，每個請求會先檢查在該請求讀取數據後，有沒有其他請求又改了該筆資料。如果其他請求有更新該筆資料，正在提交的請求會進行回滾。

相較於悲觀鎖而言，樂觀鎖認為數據一般情況下不會產生衝突，鎖鎖在資料進行提交更新的時候，才會最資料是否衝突進行檢查。當發現衝突時，返回錯誤訊息，讓使用者決定如何處理。
大多實現樂觀鎖的方式為記錄資料版本，並不會對資料表進行加鎖。

實現紀錄資料版本有兩種方式，一為使用版本號，二為使用時間戳。

### 使用版本號

可以在資料初始化時指定一個版本號，每次對資料的更新操作都會對版號進行 +1，並判斷目前版號是不是該筆資料的最新版號。

```sql
-- 查詢出商品訊息
select (status, status, version) from t_goods where id=#{id};

-- 根據商品訊息產生訂單
-- 修改商品 status 為 2

update t_goods set status=2, version=version+1
where id=#{id} and version=#{version};
```

### 優點與不足

樂觀併發控制相信請求之間的資料競爭(data race)的機率小，因此直到提交時才進行鎖定，因此不會產生任何鎖與死鎖問題。但仍然有可能遇到不可預期的結果，例如：兩個請求都讀取資料庫的某一行並加以修改後寫入資料庫，此時就會發生資料衝突。

## 鎖定形式

### 共享鎖

又稱為讀鎖，其他的使用者可以併發讀取資料，但是無法修改和刪除，若一請求對某資料增加共享鎖，則其他請求只能對該資料增加共享鎖，不能加排他鎖。

### 排他鎖

又稱寫鎖，獨佔鎖。若一事務對某資料加上排他鎖，則只允許此一事務讀取和修改此資料，其他任何類型的事務都不能在此一資料加上任何類型的鎖，直到此事務釋放資料上的鎖。保證其他事務在上鎖期間不能讀取或修改該筆資料。
