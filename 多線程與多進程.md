# 多執行緒與多進程

> 進程是資源分配的最小單位，執行緒是 CPU 調度的最小單位

## 基本概念

### 程式 (程序/Program)

為完成特地任務，用某種語言編寫成的一組指令的集合。指的是一段靜態的程式碼，靜態的物件。

### 程序 (進程/Process)

為執行程式一次的過程，或是正在執行的一個程式。是一個動態的過程：他有自己生成、存在與消亡的過程。

程式是靜態的，程序是動態的，程序作為資源分配的單位，系統在執行時會為每個程序，分配不同的內存區域。

### 執行緒 (線程/thread)

程序可以進一步細分為執行緒，是一個程式內部的一個次程式。

- 若一個程序同一時間並行執行多個執行緒，就是支援多執行緒。
- 執行緒作為調度和執行的單位，每個執行緒擁有獨立的\*執行棧(execution stack)和\*程式計數器(Program Counter)，執行緒切換的開銷小。
- 多個執行緒，共享一個程序中結構：方法區、堆疊。

- 註：
  - 執行堆疊(執行棧/execution stack) 儲存有關正在執行的子程式其訊息的堆疊，在呼叫任何子程式時，主程式都必須暫存子程式執行完畢後應該返回的地址。因此若被呼叫的子程式還要呼叫其他子程式，其自身返回的地址就必須存入執行堆疊，在其自身執行完畢後再取出。
  - 程式計數器(Program Counter)
    - 紀錄程式執行中的狀態
    - 記錄下一個指令的位元址
    - 紀錄程式執行完畢的指令
    - 紀錄程式執行完成的時間

## 多執行緒與多進程的選擇與區別

|                | 多進程                                             | 多執行緒                                                     | 結論       |
| -------------- | -------------------------------------------------- | ------------------------------------------------------------ | ---------- |
| 數據共享、同步 | 數據共享複雜，需要用到 IPC；數據是分開的，同步簡單 | 因為共享進程數據，數據共享簡單，但也因為這個原因導致同步複雜 | 各有優勢   |
| 內存、CPU      | 佔用內存多，切換複雜，CPU 利用率低                 | 佔用內存少，切換簡單，CPU 利用率高                           | 執行緒優勢 |
| 建立銷毀、切換 | 建立與銷毀切換複雜，速度慢                         | 建立與銷毀，切換簡單，速度快                                 | 執行緒優勢 |
| 程式設計、除錯 | 程式設計簡單，除錯簡單                             | 程式設計複雜，除錯複雜                                       | 進程優勢   |
| 可靠性         | 進程間不會互相影響                                 | 一個執行緒掛掉教會導致整個進程掛掉                           | 進程優勢   |
| 分布式         | 適應於多核、多機分布式，擴展到多台機器比較簡單     | 適應於多核分布式                                             | 進程優勢   |

### 選擇情境

- 需要頻繁建立與銷毀 => 多執行緒

  - 常見於 web 伺服器，一個新的連線建立一個執行緒，連線斷了就銷毀執行緒。

- 需要進行大量計算 => 執行緒

  - 消耗大量 CPU，切換頻繁，如：圖像處理、算法處理。

- 強相關的處理 => 執行緒、弱相關的處理 => 進程

  - 一般 server 的任務，如：`資料收發`、`資料處理`。`資料收發`與`資料處理`為弱相關的任務，而`資料處理`又可分為`資料解碼`、`業務處理`，這兩個任務相較之下關聯性較強。因此`資料收發`與`資料處理`可以分進程設計，`資料解碼`與`業務處理`可以分執行緒設計。

- 可能要擴展到多機分布的 => 進程、多核分布的 => 執行緒

## PHP 環境下的多程序與多執行緒

PHP 為單進程同步模型，一個請求對應一個進程，I/O(input/output)是同步阻塞的，
